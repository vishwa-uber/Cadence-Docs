"use strict";(self.webpackChunkcadence=self.webpackChunkcadence||[]).push([[5984],{4800:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>a,contentTitle:()=>l,default:()=>h,frontMatter:()=>s,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"codelabs/workflow-tests-go-replayer-shadower","title":"How To Write Tests With Workflow Replayer and Shadower","description":"A video companion to this Codelab is available on our YouTube channel:","source":"@site/docs/00-codelabs/01-workflow-tests-go-replayer-shadower.md","sourceDirName":"00-codelabs","slug":"/codelabs/workflow-tests-go-replayer-shadower","permalink":"/Cadence-Docs/docs/codelabs/workflow-tests-go-replayer-shadower","draft":false,"unlisted":false,"editUrl":"https://github.com/cadence-workflow/Cadence-Docs/tree/master/docs/00-codelabs/01-workflow-tests-go-replayer-shadower.md","tags":[],"version":"current","lastUpdatedBy":"Kevin Burns","lastUpdatedAt":1753393552000,"sidebarPosition":1,"frontMatter":{"layout":"default","title":"How To Write Tests With Workflow Replayer and Shadower","permalink":"/docs/codelabs/workflow-tests-go-replayer-shadower"},"sidebar":"docsSidebar","previous":{"title":"HTTP API","permalink":"/Cadence-Docs/docs/concepts/http-api"},"next":{"title":"Introduction","permalink":"/Cadence-Docs/docs/java-client/"}}');var o=n(74848),i=n(28453);const s={layout:"default",title:"How To Write Tests With Workflow Replayer and Shadower",permalink:"/docs/codelabs/workflow-tests-go-replayer-shadower"},l="Codelab: How to Write Tests With Workflow Replayer and Shadower",a={},c=[{value:"<strong>Setup: Preparing Your Environment</strong>",id:"setup-preparing-your-environment",level:2},{value:"<strong>1. Start the Cadence Server with Advanced Visibility</strong>",id:"1-start-the-cadence-server-with-advanced-visibility",level:3},{value:"<strong>2. Install Cadence CLI</strong>",id:"2-install-cadence-cli",level:3},{value:"<strong>3. Create a Domain for this Codelab</strong>",id:"3-create-a-domain-for-this-codelab",level:3},{value:"<strong>Building and Running Our Base Workflow</strong>",id:"building-and-running-our-base-workflow",level:2},{value:"<strong>1. The Workflow and Activity Code (<code>workflow.go</code>)</strong>",id:"1-the-workflow-and-activity-code-workflowgo",level:3},{value:"<strong>2. The Worker and Client Code (<code>main.go</code>)</strong>",id:"2-the-worker-and-client-code-maingo",level:3},{value:"<strong>3. Initialize Go Module</strong>",id:"3-initialize-go-module",level:3},{value:"<strong>4. Run the Worker</strong>",id:"4-run-the-worker",level:3},{value:"<strong>5. Generate Workflow History (<code>run-workflows.sh</code>)</strong>",id:"5-generate-workflow-history-run-workflowssh",level:3},{value:"<strong>Testing Part 1: Unit Testing with WorkflowReplayer</strong>",id:"testing-part-1-unit-testing-with-workflowreplayer",level:2},{value:"<strong>Step 1: Get a Workflow History</strong>",id:"step-1-get-a-workflow-history",level:3},{value:"<strong>Step 2: Write the Replay Test</strong>",id:"step-2-write-the-replay-test",level:3},{value:"<strong>Step 3: Run the Test and See Success</strong>",id:"step-3-run-the-test-and-see-success",level:3},{value:"<strong>Testing Part 2: Integration Testing with WorkflowShadower</strong>",id:"testing-part-2-integration-testing-with-workflowshadower",level:2},{value:"<strong>Step 1: Write the Shadower Test</strong>",id:"step-1-write-the-shadower-test",level:3},{value:"<strong>Step 2: Run the Test and See Success</strong>",id:"step-2-run-the-test-and-see-success",level:3},{value:"<strong>Introduce a Breaking Change</strong>",id:"introduce-a-breaking-change",level:2},{value:"<strong>Testing the Breaking Change: Replayer Catches the Error</strong>",id:"testing-the-breaking-change-replayer-catches-the-error",level:2},{value:"<strong>Run the Test and See the Failure</strong>",id:"run-the-test-and-see-the-failure",level:3},{value:"<strong>Testing the Breaking Change: Shadower Catches the Error</strong>",id:"testing-the-breaking-change-shadower-catches-the-error",level:2},{value:"<strong>Run the Test and See it Fail</strong>",id:"run-the-test-and-see-it-fail",level:3},{value:"<strong>Cleanup</strong>",id:"cleanup",level:2},{value:"<strong>Conclusion</strong>",id:"conclusion",level:2}];function d(e){const t={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.header,{children:(0,o.jsx)(t.h1,{id:"codelab-how-to-write-tests-with-workflow-replayer-and-shadower",children:(0,o.jsx)(t.strong,{children:"Codelab: How to Write Tests With Workflow Replayer and Shadower"})})}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.strong,{children:"A video companion to this Codelab is available on our YouTube channel:"})}),"\n",(0,o.jsx)("iframe",{width:"560",height:"315",src:"https://www.youtube.com/embed/LHOr0NOp0Gc?si=iJB0TMfS5QbxWrn7",title:"YouTube video player",frameborder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share",referrerpolicy:"strict-origin-when-cross-origin",allowfullscreen:!0}),"\n",(0,o.jsx)(t.p,{children:"This Codelab is a step-by-step guide to help you create tests for your Cadence Workflows. By the end of this guide, you will be able to build a safety net for your workflow code, ensuring that changes you make don't break existing, long-running workflows."}),"\n",(0,o.jsx)(t.p,{children:"We will cover two powerful testing tools and three keys concepts in the Go client:"}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.strong,{children:(0,o.jsx)(t.a,{href:"https://cadenceworkflow.io/docs/go-client/workflow-replay-shadowing",children:"Workflow Replayer"})}),": A component for replaying a single, specific workflow history against your current code to check for non-deterministic changes."]}),"\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.strong,{children:(0,o.jsx)(t.a,{href:"https://cadenceworkflow.io/docs/go-client/workflow-replay-shadowing#workflow-shadower",children:"Workflow Shadower"})}),": A tool built on top of the replayer that can scan and test many live workflows, making it ideal for CI/CD integration."]}),"\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.strong,{children:(0,o.jsx)(t.a,{href:"https://cadenceworkflow.io/docs/go-client/workflow-non-deterministic-error",children:"Non-deterministic errors"})}),": This occurs when a code change causes a workflow to make different decisions during a replay than it did originally."]}),"\n"]}),"\n",(0,o.jsx)(t.hr,{}),"\n",(0,o.jsx)(t.h2,{id:"setup-preparing-your-environment",children:(0,o.jsx)(t.strong,{children:"Setup: Preparing Your Environment"})}),"\n",(0,o.jsx)(t.p,{children:"Let's get your local environment ready. Before we can write tests, you need a running Cadence server and the Cadence CLI to manage it."}),"\n",(0,o.jsx)(t.h3,{id:"1-start-the-cadence-server-with-advanced-visibility",children:(0,o.jsx)(t.strong,{children:"1. Start the Cadence Server with Advanced Visibility"})}),"\n",(0,o.jsx)(t.p,{children:"For local development, the easiest way to run Cadence is with Docker."}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsxs)(t.li,{children:["First, clone the Cadence server repository and start the server using the provided ",(0,o.jsx)(t.code,{children:"docker-compose-es.yml"})," file. Advanced Visibility included in the ",(0,o.jsx)(t.code,{children:"docker-compose-es.yml"})," configuration powered by Elasticsearch, is required. The ",(0,o.jsx)(t.a,{href:"https://cadenceworkflow.io/docs/go-client/workflow-replay-shadowing#scan-filters",children:"scan filters"})," for Workflow Shadower will only work if Advanced Visibility is enabled."]}),"\n"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"  # Clone the repository  \n  git clone https://github.com/cadence-workflow/cadence.git\n"})}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"  # Start the server and its dependencies  \n  cd cadence/docker && docker-compose -f docker-compose-es.yml up\n"})}),"\n",(0,o.jsx)(t.p,{children:"This will start the Cadence server, along with its dependencies. Keep this terminal window open to keep the server running."}),"\n",(0,o.jsx)(t.p,{children:"For more help getting started with the Cadence platform:"}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsx)(t.li,{children:(0,o.jsx)(t.a,{href:"https://cadenceworkflow.io/docs/get-started/server-installation",children:"Cadence Server Installation"})}),"\n",(0,o.jsx)(t.li,{children:(0,o.jsx)(t.a,{href:"https://cadenceworkflow.io/docs/concepts/search-workflows",children:"Searching Workflows (Advanced Visibility)"})}),"\n"]}),"\n",(0,o.jsx)(t.h3,{id:"2-install-cadence-cli",children:(0,o.jsx)(t.strong,{children:"2. Install Cadence CLI"})}),"\n",(0,o.jsx)(t.p,{children:"The Cadence Command Line Interface (CLI) is your primary tool for interacting with the server."}),"\n",(0,o.jsxs)(t.p,{children:["The simplest way to install the CLI is with Homebrew if you're on macOS or Linux. For other installation methods, including Docker and building from source, see the ",(0,o.jsx)(t.a,{href:"https://cadenceworkflow.io/docs/cli/",children:"official CLI documentation"}),"."]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"brew install cadence-workflow\n"})}),"\n",(0,o.jsx)(t.h3,{id:"3-create-a-domain-for-this-codelab",children:(0,o.jsx)(t.strong,{children:"3. Create a Domain for this Codelab"})}),"\n",(0,o.jsxs)(t.p,{children:["A ",(0,o.jsx)(t.strong,{children:"Domain"})," is a namespace that groups related workflows. Let's create a dedicated domain for this tutorial to keep our work isolated."]}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsxs)(t.li,{children:["Open a ",(0,o.jsx)(t.strong,{children:"new terminal window"})," and run the following command to register the domain:"]}),"\n"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:'cadence --do workflow-tests-codelab-domain domain register --rd 0 --desc "Domain for the workflow tests codelab"\n'})}),"\n",(0,o.jsxs)(t.p,{children:["You should see a confirmation that the domain was registered successfully. We will use ",(0,o.jsx)(t.code,{children:"workflow-tests-codelab-domain"})," throughout this Codelab."]}),"\n",(0,o.jsx)(t.hr,{}),"\n",(0,o.jsx)(t.h2,{id:"building-and-running-our-base-workflow",children:(0,o.jsx)(t.strong,{children:"Building and Running Our Base Workflow"})}),"\n",(0,o.jsx)(t.p,{children:"Now, let's create our initial workflow and worker code. This will be the \"version 1\" of our code that we'll use to generate workflow history."}),"\n",(0,o.jsx)(t.p,{children:"Create a new directory for your project and add the following files."}),"\n",(0,o.jsx)(t.h3,{id:"1-the-workflow-and-activity-code-workflowgo",children:(0,o.jsxs)(t.strong,{children:["1. The Workflow and Activity Code (",(0,o.jsx)(t.code,{children:"workflow.go"}),")"]})}),"\n",(0,o.jsx)(t.p,{children:"This file defines the business logic of our workflow. It executes two activities with a one-minute pause in between."}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-go",children:'// workflow.go\npackage main\n\nimport (\n\t"context"\n\t"fmt"\n\t"time"\n\n\t"go.uber.org/cadence/activity"\n\t"go.uber.org/cadence/workflow"\n\t"go.uber.org/zap"\n)\n\n// SimpleWorkflow defines a basic workflow that calls two activities.\nfunc SimpleWorkflow(ctx workflow.Context, name string) (string, error) {\n\tao := workflow.ActivityOptions{\n\t\tTaskList:               "my-task-list",\n\t\tScheduleToCloseTimeout: time.Minute,\n\t\tScheduleToStartTimeout: time.Minute,\n\t\tStartToCloseTimeout:    time.Minute,\n\t}\n\tctx = workflow.WithActivityOptions(ctx, ao)\n\n\tlogger := workflow.GetLogger(ctx)\n\tlogger.Info("SimpleWorkflow started.")\n\n\tvar activityAResult string\n\terr := workflow.ExecuteActivity(ctx, ActivityA, name).Get(ctx, &activityAResult)\n\tif err != nil {\n\t\tlogger.Error("Activity A failed.", zap.Error(err))\n\t\treturn "", err\n\t}\n\n\tworkflow.Sleep(ctx, time.Minute) // Wait for 1 minute\n\n\tvar activityBResult string\n\terr = workflow.ExecuteActivity(ctx, ActivityB, activityAResult).Get(ctx, &activityBResult)\n\tif err != nil {\n\t\tlogger.Error("Activity B failed.", zap.Error(err))\n\t\treturn "", err\n\t}\n\n\tresult := fmt.Sprintf("Workflow completed. Final result: %s", activityBResult)\n\tlogger.Info(result)\n\treturn result, nil\n}\n\n// ActivityA is a simple activity that returns a greeting.\nfunc ActivityA(ctx context.Context, name string) (string, error) {\n\tlogger := activity.GetLogger(ctx)\n\tlogger.Info("Activity A started.")\n\treturn fmt.Sprintf("Hello, %s!", name), nil\n}\n\n// ActivityB is another simple activity.\nfunc ActivityB(ctx context.Context, input string) (string, error) {\n\tlogger := activity.GetLogger(ctx)\n\tlogger.Info("Activity B started.")\n\treturn fmt.Sprintf("Processed message: \'%s\'", input), nil\n}\n\n'})}),"\n",(0,o.jsx)(t.h3,{id:"2-the-worker-and-client-code-maingo",children:(0,o.jsxs)(t.strong,{children:["2. The Worker and Client Code (",(0,o.jsx)(t.code,{children:"main.go"}),")"]})}),"\n",(0,o.jsx)(t.p,{children:"This file contains the main function to set up and run a Cadence worker. The worker polls for tasks, executing the workflow and activity code defined in workflow.go."}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-go",children:'// main.go\npackage main\n\nimport (\n\tapiv1 "github.com/uber/cadence-idl/go/proto/api/v1"\n\t"go.uber.org/cadence/.gen/go/cadence/workflowserviceclient"\n\t"go.uber.org/cadence/compatibility"\n\t"go.uber.org/cadence/worker"\n\t"go.uber.org/cadence/workflow"\n\t"go.uber.org/cadence/activity"\n\t"go.uber.org/yarpc"\n\t"go.uber.org/yarpc/transport/grpc"\n\t"go.uber.org/zap"\n\t"go.uber.org/zap/zapcore"\n)\n\nconst (\n\tDomain   = "workflow-tests-codelab-domain"\n\tHostPort = "127.0.0.1:7833"\n\tTaskList \t   = "my-task-list"\n\tClientName     = "cadence-samples-worker"\n\tCadenceService = "cadence-frontend"\n)\n\nfunc main() {\n\t// Create logger\n\tlogger, err:= zap.NewDevelopment(zap.AddStacktrace(zapcore.ErrorLevel))\n\tif err != nil {\n\t\tpanic("Failed to setup logger: " + err.Error())\n\t}\n\t// Create workflow service client\n\tcadenceClient :=  BuildCadenceClient()\n\n\t// Create worker and register workflows and activities\n\tworkerOptions := worker.Options{\n\t\tLogger:       logger,\n\t}\n\tw := worker.New(cadenceClient, Domain, TaskList, workerOptions)\n\tw.RegisterWorkflowWithOptions(SimpleWorkflow, workflow.RegisterOptions{Name: "workflow-shadowing.SimpleWorkflow"})\n\tw.RegisterActivityWithOptions(ActivityA, activity.RegisterOptions{Name: "workflow-shadowing.ActivityA"})\n\tw.RegisterActivityWithOptions(ActivityB, activity.RegisterOptions{Name: "workflow-shadowing.ActivityB"})\n\t\n\tlogger.Info("Starting worker.", zap.String("Domain", Domain), zap.String("TaskList", TaskList))\n\n\t// Start worker\n\terr = w.Start()\n\tif err != nil {\n\t\tlogger.Fatal("Failed to start worker.", zap.Error(err))\n\t}\n\n\t// Prevent main from exiting\n\tselect {}\n}\n\nfunc BuildCadenceClient() workflowserviceclient.Interface { \n\tdispatcher := yarpc.NewDispatcher(yarpc.Config{\n\t\tName: ClientName,\n\t\tOutbounds: yarpc.Outbounds{\n\t\t\tCadenceService: {Unary: grpc.NewTransport().NewSingleOutbound(HostPort)},\n\t\t},\n\t})\n\tif err := dispatcher.Start(); err != nil {\n\t\tpanic("Failed to start dispatcher: " + err.Error())\n\t}\n\n\tclientConfig := dispatcher.ClientConfig(CadenceService)\n\n\treturn compatibility.NewThrift2ProtoAdapter(\n\t\tapiv1.NewDomainAPIYARPCClient(clientConfig),\n\t\tapiv1.NewWorkflowAPIYARPCClient(clientConfig),\n\t\tapiv1.NewWorkerAPIYARPCClient(clientConfig),\n\t\tapiv1.NewVisibilityAPIYARPCClient(clientConfig),\n\t)\n}\n\n\n'})}),"\n",(0,o.jsx)(t.h3,{id:"3-initialize-go-module",children:(0,o.jsx)(t.strong,{children:"3. Initialize Go Module"})}),"\n",(0,o.jsx)(t.p,{children:"Before running the worker, you need to initialize the Go module and install dependencies."}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsx)(t.li,{children:"Open a terminal in your project directory and run:"}),"\n"]}),"\n",(0,o.jsx)(t.p,{children:"Initialize the Go module"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"go mod init workflow-shadowing\n"})}),"\n",(0,o.jsx)(t.p,{children:"Download the dependencies"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"go mod tidy\n"})}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.strong,{children:"If you see any errors like this:"})}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{children:"ambiguous import: found package google.golang.org/genproto/googleapis...\n"})}),"\n",(0,o.jsxs)(t.p,{children:["Add the following to your ",(0,o.jsx)(t.code,{children:"go.mod"})," file and run ",(0,o.jsx)(t.code,{children:"go mod tidy"})," again."]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-go",children:"// Explicitly require the newer split modules\nrequire (\n    google.golang.org/genproto/googleapis/rpc v0.0.0-20240814211410-ddb44dafa142\n)\n\n// Exclude the old monolithic module that causes conflicts\nexclude (\n    google.golang.org/genproto v0.0.0-20200212174721-66ed5ce911ce\n)\n"})}),"\n",(0,o.jsxs)(t.p,{children:["You should now have a ",(0,o.jsx)(t.code,{children:"go.mod"})," and a ",(0,o.jsx)(t.code,{children:"go.sum"})," file. You are ready to run the worker."]}),"\n",(0,o.jsx)(t.h3,{id:"4-run-the-worker",children:(0,o.jsx)(t.strong,{children:"4. Run the Worker"})}),"\n",(0,o.jsx)(t.p,{children:"With both files created, start your worker. It will connect to the Cadence server and begin polling for tasks on my-task-list."}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsxs)(t.li,{children:["In the same terminal, run the following to start your ",(0,o.jsx)(t.code,{children:"Worker"}),":"]}),"\n"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"go run .\n"})}),"\n",(0,o.jsxs)(t.p,{children:["*",(0,o.jsx)(t.em,{children:"Leave this worker running."})]}),"\n",(0,o.jsx)(t.h3,{id:"5-generate-workflow-history-run-workflowssh",children:(0,o.jsxs)(t.strong,{children:["5. Generate Workflow History (",(0,o.jsx)(t.code,{children:"run-workflows.sh"}),")"]})}),"\n",(0,o.jsx)(t.p,{children:"Now we need to create some workflow histories to test against later."}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsxs)(t.li,{children:["Create a new shell script named ",(0,o.jsx)(t.code,{children:"run-workflows.sh"})," in your project directory. This version allows you to specify the number of workflows to run as a command-line argument, defaulting to 20 if not provided."]}),"\n"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:'#!/bin/bash\n\n# run-workflows.sh  \n# Usage: ./run-workflows.sh [number_of_workflows]\n\n# Use the first command-line argument for the count, or default to 20.  \nCOUNT=${1:-20}\n\necho "Starting $COUNT instances of SimpleWorkflow..."\n\nfor i in $(seq 1 $COUNT)  \ndo  \n  WORKFLOW_ID="codelab-workflow-$i"  \n  cadence --do workflow-tests-codelab-domain workflow start  \\\n    --tl my-task-list   \\\n    --wt workflow-shadowing.SimpleWorkflow   \\\n    --et 600   \\\n    --wid "$WORKFLOW_ID"   \\\n    -i \'"World"\'  \n  echo "Started workflow with ID: $WORKFLOW_ID"  \n  sleep 1 # Sleep for a second to not overwhelm the server  \ndone\n\necho "Finished starting workflows."\n'})}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsx)(t.li,{children:"Make the script executable and run it to start 20 workflow executions."}),"\n"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"chmod +x run-workflows.sh\n"})}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"./run-workflows.sh\n"})}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.strong,{children:"Or, run with a specific number, like 5"})}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"./run-workflows.sh 5\n"})}),"\n",(0,o.jsx)(t.p,{children:"You have now successfully created running instances of SimpleWorkflow. This history is stored in Cadence and is what we will test against."}),"\n",(0,o.jsx)(t.hr,{}),"\n",(0,o.jsx)(t.h2,{id:"testing-part-1-unit-testing-with-workflowreplayer",children:(0,o.jsx)(t.strong,{children:"Testing Part 1: Unit Testing with WorkflowReplayer"})}),"\n",(0,o.jsx)(t.p,{children:"The WorkflowReplayer is your first line of defense. It allows you to test your code changes against the history of a single, specific workflow execution. This is perfect for unit tests."}),"\n",(0,o.jsx)(t.p,{children:"Let's start by testing our current workflow code to ensure it's compatible with existing workflow histories. This will establish a baseline of success before we make any changes."}),"\n",(0,o.jsx)(t.h3,{id:"step-1-get-a-workflow-history",children:(0,o.jsx)(t.strong,{children:"Step 1: Get a Workflow History"})}),"\n",(0,o.jsx)(t.p,{children:"First, you need the history of a completed workflow to test against. Use the CLI to find a workflow that has already completed and save its history to a file."}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"# First, list recent workflows to find a completed one  \ncadence --do workflow-tests-codelab-domain workflow list\n\n# Pick a Workflow ID and Run ID from the list and save its history  \ncadence --do workflow-tests-codelab-domain workflow show --wid <workflow-id> --rid <run-id> --of history.json\n"})}),"\n",(0,o.jsx)(t.h3,{id:"step-2-write-the-replay-test",children:(0,o.jsx)(t.strong,{children:"Step 2: Write the Replay Test"})}),"\n",(0,o.jsxs)(t.p,{children:["Now, create a new file named ",(0,o.jsx)(t.code,{children:"workflow_replayer_test.go"}),". This test will use the history file you just downloaded to verify that our current code is compatible with existing workflow histories."]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-go",children:'//workflow_replayer_test.go\npackage main\n\nimport (\n\t"testing"\n\n\t"github.com/stretchr/testify/require"\n\t"go.uber.org/cadence/worker"\n\t"go.uber.org/cadence/workflow"\n\t"go.uber.org/zap"\n)\n\nfunc TestReplayWorkflowHistory(t *testing.T) {  \n\treplayer := worker.NewWorkflowReplayer()\n\n\t// Register our current workflow definition \n\treplayer.RegisterWorkflowWithOptions(SimpleWorkflow, workflow.RegisterOptions{Name: "workflow-shadowing.SimpleWorkflow"})  \n\n\terr := replayer.ReplayWorkflowHistoryFromJSONFile(zap.NewNop(), "history.json")  \n\t  \n\t// This test should PASS because our current code matches the history  \n\trequire.NoError(t, err, "The workflow replay should succeed with our current code.")  \n}\n'})}),"\n",(0,o.jsx)(t.h3,{id:"step-3-run-the-test-and-see-success",children:(0,o.jsx)(t.strong,{children:"Step 3: Run the Test and See Success"})}),"\n",(0,o.jsx)(t.p,{children:"Run the test from your terminal."}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"go test -run TestReplayWorkflowHistory -v\n"})}),"\n",(0,o.jsx)(t.p,{children:"The test should pass! This confirms that our current workflow code is compatible with existing workflow histories. You should see output similar to:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{children:"=== RUN   TestReplayWorkflowHistory\n--- PASS: TestReplayWorkflowHistory (0.01s)\nPASS\n"})}),"\n",(0,o.jsx)(t.p,{children:"This successful test establishes that our testing framework is working correctly and our current code is safe."}),"\n",(0,o.jsx)(t.hr,{}),"\n",(0,o.jsx)(t.h2,{id:"testing-part-2-integration-testing-with-workflowshadower",children:(0,o.jsx)(t.strong,{children:"Testing Part 2: Integration Testing with WorkflowShadower"})}),"\n",(0,o.jsx)(t.p,{children:"The WorkflowReplayer is great, but manually downloading histories isn't scalable for a CI pipeline. WorkflowShadower automates this process by scanning live workflows from a domain and replaying them on the fly."}),"\n",(0,o.jsx)(t.p,{children:"Let's test our current workflow code using the shadower to ensure it's compatible with all the workflow histories in our domain."}),"\n",(0,o.jsx)(t.h3,{id:"step-1-write-the-shadower-test",children:(0,o.jsx)(t.strong,{children:"Step 1: Write the Shadower Test"})}),"\n",(0,o.jsxs)(t.p,{children:["Create a new file named ",(0,o.jsx)(t.code,{children:"workflow_shadower_test.go"}),". This test will connect to your Cadence server and attempt to replay a sample of recent workflows from the domain we created."]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-go",children:'// workflow_shadower_test.go\npackage main\n\nimport (\n\t"testing"\n\t"time"\n\n\t"github.com/stretchr/testify/assert"\n\t"go.uber.org/cadence/worker"\n\t"go.uber.org/cadence/workflow"\n\t"go.uber.org/zap"\n)\n\nfunc TestShadowRecentWorkflows(t *testing.T) {       \n    //Create workflow service client\n\tcadenceClient :=  BuildCadenceClient()\n\n\t// Shadow workflows that started in the last 24 hours  \n\t// and stop after successfully replaying 20 of them.  \n\tshadowOptions := worker.ShadowOptions{  \n\t\tWorkflowStartTimeFilter: worker.TimeFilter{  \n\t\t\t// Subtract 24 hours from the current time\n\t\t\tMinTimestamp: time.Now().Add(-24 * time.Hour),  \n\t\t},  \n\t\tExitCondition: worker.ShadowExitCondition{  \n\t\t\tShadowCount: 20,  \n\t\t},\n\t\tWorkflowStatus: []string{"Completed"},\n\t}  \n\n\t// Create shadower\n\tshadower, err := worker.NewWorkflowShadower(  \n\t\tcadenceClient,  \n\t\tDomain, // Using the constant from main.go  \n\t\tshadowOptions,  \n\t\tworker.ReplayOptions{}, // Can add custom converters, etc. here  \n\t\tzap.NewNop(),  \n\t)  \n\tassert.NoError(t, err)  \n      \n    // Register our current workflow definition\n\tshadower.RegisterWorkflowWithOptions(SimpleWorkflow, workflow.RegisterOptions{Name: "workflow-shadowing.SimpleWorkflow"})  \n\n\t// Run will fetch and replay workflows. It will return an error  \n\t// if any of them have a non-deterministic failure.  \n\terr = shadower.Run()  \n\tassert.NoError(t, err, "Shadower should not find any non-deterministic workflows")  \n}\n'})}),"\n",(0,o.jsx)(t.h3,{id:"step-2-run-the-test-and-see-success",children:(0,o.jsx)(t.strong,{children:"Step 2: Run the Test and See Success"})}),"\n",(0,o.jsx)(t.p,{children:"Run the shadower test from your terminal."}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"go test -run TestShadowRecentWorkflows -v\n"})}),"\n",(0,o.jsx)(t.p,{children:"The test should pass! This confirms that our current workflow code is compatible with all the existing workflow histories in our domain. You should see output similar to:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{children:"=== RUN   TestShadowRecentWorkflows\n--- PASS: TestShadowRecentWorkflows (0.08s)\nPASS\n"})}),"\n",(0,o.jsx)(t.p,{children:"This successful test demonstrates that the shadower can scan multiple workflows from your domain and verify compatibility automatically. This is exactly what you'd want running in your CI/CD pipeline."}),"\n",(0,o.jsx)(t.hr,{}),"\n",(0,o.jsx)(t.h2,{id:"introduce-a-breaking-change",children:(0,o.jsx)(t.strong,{children:"Introduce a Breaking Change"})}),"\n",(0,o.jsx)(t.p,{children:"Now that we've established that our testing tools work correctly with our current code, let's see what happens when we introduce a breaking change."}),"\n",(0,o.jsxs)(t.p,{children:["A ",(0,o.jsx)(t.a,{href:"https://cadenceworkflow.io/docs/go-client/workflow-non-deterministic-error",children:"non-deterministic error"})," occurs when a code change causes a workflow to make different decisions during a replay than it did originally."]}),"\n",(0,o.jsxs)(t.p,{children:["Let's introduce a ",(0,o.jsx)(t.strong,{children:"breaking change"})," to our ",(0,o.jsx)(t.code,{children:"workflow.go"})," file. We will add a new activity call right after ",(0,o.jsx)(t.code,{children:"ActivityA"}),"."]}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsxs)(t.li,{children:["Modify ",(0,o.jsx)(t.code,{children:"workflow.go"}),":"]}),"\n"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-go",children:"// workflow.go\n// ... inside the SimpleWorkflow function  \n\tvar activityAResult string  \n\terr := workflow.ExecuteActivity(ctx, ActivityA, name).Get(ctx, &activityAResult)  \n//...\n\n// NEWLY ADDED CODE  \n\tvar activityCResult string  \n\tworkflow.ExecuteActivity(ctx, ActivityC, activityAResult).Get(ctx, &activityCResult)  \n// END NEWLY ADDED CODE\n\n\tworkflow.Sleep(ctx, time.Minute) // Wait for 1 minute  \n// ...\n"})}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsxs)(t.li,{children:["Next, define ",(0,o.jsx)(t.code,{children:"ActivityC"})," and register it in ",(0,o.jsx)(t.code,{children:"main.go"}),":"]}),"\n"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-go",children:'// workflow.go  \nfunc ActivityC(ctx context.Context, input string) (string, error) {  \n\treturn fmt.Sprintf("Activity C processed: \'%s\'", input), nil  \n}\n\n// main.go  \n// ... in main() function  \nw.RegisterActivityWithOptions(ActivityC, activity.RegisterOptions{Name: "workflow-shadowing.ActivityC"})\n \n// ...\n'})}),"\n",(0,o.jsx)(t.p,{children:"If you were to restart your worker now, any of the 20 workflows that were past ActivityA but paused at the Sleep would fail with a non-deterministic error. Let's prove this with our testing tools."}),"\n",(0,o.jsx)(t.hr,{}),"\n",(0,o.jsx)(t.h2,{id:"testing-the-breaking-change-replayer-catches-the-error",children:(0,o.jsx)(t.strong,{children:"Testing the Breaking Change: Replayer Catches the Error"})}),"\n",(0,o.jsx)(t.p,{children:"Now let's see how our replayer test catches this breaking change."}),"\n",(0,o.jsx)(t.h3,{id:"run-the-test-and-see-the-failure",children:(0,o.jsx)(t.strong,{children:"Run the Test and See the Failure"})}),"\n",(0,o.jsx)(t.p,{children:"Run the replayer test from your terminal."}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"go test -run TestReplayWorkflowHistory  -v\n"})}),"\n",(0,o.jsx)(t.p,{children:"The test will fail! The error message clearly indicates that the replay produced an extra command that wasn't in the original history, pinpointing the non-deterministic change."}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{children:"    workflow_replayer_test.go:22:   \n        \tError Trace:\tworkflow_replayer_test.go:22  \n        \tError:      \tReceived unexpected error:  \n        \t            \tnondeterministic workflow: history event is TimerStarted: (TimerId:1, StartToFireTimeoutSeconds:60, DecisionTaskCompletedEventId:10), replay decision is ScheduleActivityTask: (ActivityId:1, ActivityType:(Name:workflow-shadowing.ActivityC)...\n        \tTest:       \tTestReplayWorkflowHistory\n--- FAIL: TestReplayWorkflowHistory (0.01s) \n"})}),"\n",(0,o.jsx)(t.p,{children:"This test successfully caught the breaking change before it could affect production workflows."}),"\n",(0,o.jsx)(t.hr,{}),"\n",(0,o.jsx)(t.h2,{id:"testing-the-breaking-change-shadower-catches-the-error",children:(0,o.jsx)(t.strong,{children:"Testing the Breaking Change: Shadower Catches the Error"})}),"\n",(0,o.jsx)(t.p,{children:"Let's also see how our shadower test catches this same breaking change."}),"\n",(0,o.jsx)(t.h3,{id:"run-the-test-and-see-it-fail",children:(0,o.jsx)(t.strong,{children:"Run the Test and See it Fail"})}),"\n",(0,o.jsx)(t.p,{children:"Run the shadower test from your terminal."}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"go test -run TestShadowRecentWorkflows  -v\n"})}),"\n",(0,o.jsxs)(t.p,{children:["Like the replayer test, this will also fail. The shadower will find one of the workflows we started earlier, attempt to replay its history with our modified code, and immediately detect the non-deterministic error. The error occurs because the replayer expected a ",(0,o.jsx)(t.code,{children:"TimerStarted"})," task but instead a ",(0,o.jsx)(t.code,{children:"ScheduleActivityTask"})," for ",(0,o.jsx)(t.code,{children:"ActivityC"}),"."]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{children:"    workflow_shadower_test.go:48   \n        \tError Trace:\tworkflow_shadower_test.go:48  \n        \tError:      \tReceived unexpected error:  \n\t\t\t\tnondeterministic workflow: history event is TimerStarted: (TimerId:1, StartToFireTimeoutSeconds:60, DecisionTaskCompletedEventId:10), replay decision is ScheduleActivityTask: (ActivityId:1, ActivityType:(Name:workflow-shadowing.ActivityC)...\n        \tTest:       \tTestShadowRecentWorkflows\n--- FAIL: TestShadowRecentWorkflows (0.17s) \n"})}),"\n",(0,o.jsx)(t.p,{children:"This provides a powerful, automated way to validate changes against real-world workflow executions."}),"\n",(0,o.jsx)(t.hr,{}),"\n",(0,o.jsx)(t.h2,{id:"cleanup",children:(0,o.jsx)(t.strong,{children:"Cleanup"})}),"\n",(0,o.jsx)(t.p,{children:"Once you've completed the Codelab, you can deprecate and then delete the domain to keep your local Cadence server clean."}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsx)(t.li,{children:"To deprecate the domain, run the following command:"}),"\n"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"cadence --do workflow-tests-codelab-domain domain deprecate \n"})}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsx)(t.li,{children:"To delete the domain, run the following command:"}),"\n"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"cadence --do workflow-tests-codelab-domain domain delete \n"})}),"\n",(0,o.jsx)(t.hr,{}),"\n",(0,o.jsx)(t.h2,{id:"conclusion",children:(0,o.jsx)(t.strong,{children:"Conclusion"})}),"\n",(0,o.jsx)(t.p,{children:"By using WorkflowReplayer for unit tests and WorkflowShadower for broader integration tests, you can build a comprehensive CI/CD gate. This ensures your Cadence Workflows remain backward-compatible, giving you the confidence to develop and deploy changes freely without risking the integrity of your long-running business processes."})]})}function h(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>s,x:()=>l});var r=n(96540);const o={},i=r.createContext(o);function s(e){const t=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function l(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),r.createElement(i.Provider,{value:t},e.children)}}}]);