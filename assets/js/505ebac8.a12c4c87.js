"use strict";(globalThis.webpackChunkcadence=globalThis.webpackChunkcadence||[]).push([[5996],{28453:(e,o,n)=>{n.d(o,{R:()=>l,x:()=>s});var r=n(96540);const i={},t=r.createContext(i);function l(e){const o=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(o):{...o,...e}},[o,e])}function s(e){let o;return o=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),r.createElement(t.Provider,{value:o},e.children)}},96237:(e,o,n)=>{n.r(o),n.d(o,{assets:()=>a,contentTitle:()=>s,default:()=>h,frontMatter:()=>l,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"go-client/workflow-replay-shadowing","title":"Workflow Replay and Shadowing","description":"In the Versioning section, we mentioned that incompatible changes to workflow definition code could cause non-deterministic issues when processing workflow tasks if versioning is not done correctly. However, it may be hard for you to tell if a particular change is incompatible or not and whether versioning logic is needed. To help you identify incompatible changes and catch them before production traffic is impacted, we implemented Workflow Replayer and Workflow Shadower.","source":"@site/docs/05-go-client/19-workflow-replay-shadowing.md","sourceDirName":"05-go-client","slug":"/go-client/workflow-replay-shadowing","permalink":"/Cadence-Docs/docs/go-client/workflow-replay-shadowing","draft":false,"unlisted":false,"editUrl":"https://github.com/cadence-workflow/Cadence-Docs/tree/master/docs/05-go-client/19-workflow-replay-shadowing.md","tags":[],"version":"current","lastUpdatedBy":"Kevin Burns","lastUpdatedAt":1753393552000,"sidebarPosition":19,"frontMatter":{"layout":"default","title":"Workflow Replay and Shadowing","permalink":"/docs/go-client/workflow-replay-shadowing"},"sidebar":"docsSidebar","previous":{"title":"Tracing and context propagation","permalink":"/Cadence-Docs/docs/go-client/tracing"},"next":{"title":"Workflow Non-deterministic errors","permalink":"/Cadence-Docs/docs/go-client/workflow-non-deterministic-error"}}');var i=n(74848),t=n(28453);const l={layout:"default",title:"Workflow Replay and Shadowing",permalink:"/docs/go-client/workflow-replay-shadowing"},s="Workflow Replay and Shadowing",a={},d=[{value:"Hands-On Codelab",id:"hands-on-codelab",level:2},{value:"Workflow Replayer",id:"workflow-replayer",level:2},{value:"Replay Options",id:"replay-options",level:3},{value:"Replayer Creation",id:"replayer-creation",level:4},{value:"ReplayOptions Fields",id:"replayoptions-fields",level:4},{value:"Registration Methods",id:"registration-methods",level:4},{value:"Replay Methods",id:"replay-methods",level:4},{value:"Error Conditions",id:"error-conditions",level:4},{value:"Downloading History",id:"downloading-history",level:4},{value:"Sample Unit Test",id:"sample-unit-test",level:3},{value:"Workflow Shadower",id:"workflow-shadower",level:2},{value:"Shadow Options",id:"shadow-options",level:3},{value:"Scan Filters: Advanced Query",id:"scan-filters-advanced-query",level:4},{value:"Scan Filters: Basic",id:"scan-filters-basic",level:4},{value:"Shadow Exit Condition",id:"shadow-exit-condition",level:4},{value:"Shadow Mode",id:"shadow-mode",level:4},{value:"Shadow Concurrency",id:"shadow-concurrency",level:4},{value:"Sample Integration Test",id:"sample-integration-test",level:3},{value:"Shadowing Worker",id:"shadowing-worker",level:2},{value:"How to Set Up",id:"how-to-set-up",level:3}];function c(e){const o={a:"a",blockquote:"blockquote",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(o.header,{children:(0,i.jsx)(o.h1,{id:"workflow-replay-and-shadowing",children:"Workflow Replay and Shadowing"})}),"\n",(0,i.jsx)(o.p,{children:"In the Versioning section, we mentioned that incompatible changes to workflow definition code could cause non-deterministic issues when processing workflow tasks if versioning is not done correctly. However, it may be hard for you to tell if a particular change is incompatible or not and whether versioning logic is needed. To help you identify incompatible changes and catch them before production traffic is impacted, we implemented Workflow Replayer and Workflow Shadower."}),"\n",(0,i.jsx)(o.h2,{id:"hands-on-codelab",children:"Hands-On Codelab"}),"\n",(0,i.jsxs)(o.p,{children:[(0,i.jsx)(o.strong,{children:"Ready for hands-on learning?"})," Follow our step-by-step ",(0,i.jsx)(o.a,{href:"/Cadence-Docs/docs/codelabs/workflow-tests-go-replayer-shadower",children:(0,i.jsx)(o.strong,{children:"Workflow Testing Codelab"})})," to build a complete testing setup from scratch."]}),"\n",(0,i.jsxs)(o.p,{children:[(0,i.jsx)(o.strong,{children:"You'll learn:"})," Replayer setup \u2022 Shadower integration \u2022 Breaking change detection",(0,i.jsx)("br",{}),"\n",(0,i.jsx)(o.strong,{children:"Time commitment:"})," 30-45 minutes"]}),"\n",(0,i.jsx)(o.h2,{id:"workflow-replayer",children:"Workflow Replayer"}),"\n",(0,i.jsx)(o.p,{children:"Workflow Replayer is a testing component for replaying existing workflow histories against a workflow definition. The replaying logic is the same as the one used for processing workflow tasks, so if there are any incompatible changes in the workflow definition, the replay test will fail."}),"\n",(0,i.jsx)(o.h3,{id:"replay-options",children:"Replay Options"}),"\n",(0,i.jsxs)(o.p,{children:["Complete documentation on replay options which includes default values, accepted values, etc. can be found ",(0,i.jsx)(o.a,{href:"https://github.com/cadence-workflow/cadence-go-client/blob/master/internal/workflow_replayer.go",children:"here"}),". The following sections are just a brief description of each option."]}),"\n",(0,i.jsx)(o.h4,{id:"replayer-creation",children:"Replayer Creation"}),"\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsxs)(o.li,{children:[(0,i.jsx)(o.strong,{children:"NewWorkflowReplayer()"}),": Default replayer constructor with standard configuration."]}),"\n",(0,i.jsxs)(o.li,{children:[(0,i.jsx)(o.strong,{children:"NewWorkflowReplayWithOptions(ReplayOptions)"}),": Advanced constructor with customizable replay configuration."]}),"\n"]}),"\n",(0,i.jsx)(o.h4,{id:"replayoptions-fields",children:"ReplayOptions Fields"}),"\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsxs)(o.li,{children:[(0,i.jsx)(o.strong,{children:"DataConverter"}),": Custom data converter interface for workflow argument/result serialization."]}),"\n",(0,i.jsxs)(o.li,{children:[(0,i.jsx)(o.strong,{children:"ContextPropagators"}),": Slice of context propagators for maintaining request context during replay."]}),"\n",(0,i.jsxs)(o.li,{children:[(0,i.jsx)(o.strong,{children:"WorkflowInterceptorChainFactories"}),": Slice of interceptor factories for workflow execution middleware."]}),"\n",(0,i.jsxs)(o.li,{children:[(0,i.jsx)(o.strong,{children:"Tracer"}),": OpenTracing tracer interface for distributed tracing support."]}),"\n"]}),"\n",(0,i.jsxs)(o.blockquote,{children:["\n",(0,i.jsxs)(o.p,{children:["\u26a0\ufe0f ",(0,i.jsx)(o.strong,{children:"Important:"})," Replay options must exactly match your production worker settings to ensure accurate replay results."]}),"\n"]}),"\n",(0,i.jsx)(o.h4,{id:"registration-methods",children:"Registration Methods"}),"\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsxs)(o.li,{children:[(0,i.jsx)(o.strong,{children:"RegisterWorkflow(workflowFunc)"}),": Standard registration using Go function name as workflow type."]}),"\n",(0,i.jsxs)(o.li,{children:[(0,i.jsx)(o.strong,{children:"RegisterWorkflow(workflowFunc, RegisterOptions)"}),": Registration with custom workflow name and additional options."]}),"\n"]}),"\n",(0,i.jsxs)(o.blockquote,{children:["\n",(0,i.jsxs)(o.p,{children:["\u26a0\ufe0f ",(0,i.jsx)(o.strong,{children:"Critical:"})," All registration methods and options must exactly match those used during original workflow execution."]}),"\n"]}),"\n",(0,i.jsx)(o.h4,{id:"replay-methods",children:"Replay Methods"}),"\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsxs)(o.li,{children:[(0,i.jsx)(o.strong,{children:"ReplayWorkflowHistory(logger, WorkflowHistory)"}),": Replay from pre-loaded workflow history object in memory."]}),"\n",(0,i.jsxs)(o.li,{children:[(0,i.jsx)(o.strong,{children:"ReplayWorkflowHistoryFromJSONFile(logger, string)"}),": Replay from JSON file created by ",(0,i.jsx)(o.code,{children:"cadence workflow show --of filename.json"}),"."]}),"\n",(0,i.jsxs)(o.li,{children:[(0,i.jsx)(o.strong,{children:"ReplayPartialWorkflowHistoryFromJSONFile(logger, string, int64)"}),": Replay partial history up to specified decision task event ID."]}),"\n",(0,i.jsxs)(o.li,{children:[(0,i.jsx)(o.strong,{children:"ReplayWorkflowExecution(context, WorkflowServiceClient, logger, string, WorkflowExecution)"}),": Fetch and replay directly from Cadence server."]}),"\n"]}),"\n",(0,i.jsx)(o.h4,{id:"error-conditions",children:"Error Conditions"}),"\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsxs)(o.li,{children:[(0,i.jsx)(o.strong,{children:"Non-deterministic Changes"}),": Workflow code modifications that alter execution flow will cause replay failures."]}),"\n",(0,i.jsxs)(o.li,{children:[(0,i.jsx)(o.strong,{children:"Insufficient History"}),": Minimum of 3 workflow events required for meaningful replay validation."]}),"\n"]}),"\n",(0,i.jsx)(o.h4,{id:"downloading-history",children:"Downloading History"}),"\n",(0,i.jsx)(o.p,{children:"Replayer can read workflow history from a local JSON file or fetch it directly from the Cadence server. If you would like to use the first method, you can use the following CLI command, otherwise you can skip to the next step."}),"\n",(0,i.jsx)(o.pre,{children:(0,i.jsx)(o.code,{className:"language-bash",children:"cadence --do <domain> workflow show --wid <workflowID> --rid <runID> --of <output file name>\n"})}),"\n",(0,i.jsx)(o.h3,{id:"sample-unit-test",children:"Sample Unit Test"}),"\n",(0,i.jsxs)(o.p,{children:["This sample is also available in our samples repo ",(0,i.jsx)(o.a,{href:"https://github.com/cadence-workflow/cadence-samples/blob/6350c61d16487d3a6cf9b31e3fac6967170c71ba/cmd/samples/recipes/helloworld/replay_test.go#L18",children:"here"}),"."]}),"\n",(0,i.jsx)(o.pre,{children:(0,i.jsx)(o.code,{className:"language-go",children:'func TestReplayWorkflowHistoryFromFile(t *testing.T) {\n\treplayer := worker.NewWorkflowReplayer()\n\treplayer.RegisterWorkflow(helloWorldWorkflow)\n\terr := replayer.ReplayWorkflowHistoryFromJSONFile(zaptest.NewLogger(t), "helloworld.json")\n\trequire.NoError(t, err)\n}\n'})}),"\n",(0,i.jsx)(o.h2,{id:"workflow-shadower",children:"Workflow Shadower"}),"\n",(0,i.jsx)(o.p,{children:"Workflow Replayer works well when verifying the compatibility against a small number of workflow histories. If there are a lot of workflows in production that need to be verified, dumping all histories manually clearly won't work. Directly fetching histories from the Cadence server might be a solution, but the time to replay all workflow histories might be too long for a test."}),"\n",(0,i.jsx)(o.p,{children:"Workflow Shadower is built on top of Workflow Replayer to address this problem. The basic idea of shadowing is: scan workflows based on the filters you defined, fetch history for each of workflow in the scan result from Cadence server and run the replay test. It can be run either as a test to serve local development purposes or as a workflow in your worker to continuously replay production workflows."}),"\n",(0,i.jsx)(o.h3,{id:"shadow-options",children:"Shadow Options"}),"\n",(0,i.jsxs)(o.p,{children:["Complete documentation on shadow options which includes default values, accepted values, etc. can be found ",(0,i.jsx)(o.a,{href:"https://github.com/cadence-workflow/cadence-go-client/blob/2af19f25b056ce1039feaeabd3fb0e803d20010b/internal/workflow_shadower.go#L53",children:"here"}),". The following sections are just a brief description of each option."]}),"\n",(0,i.jsx)(o.h4,{id:"scan-filters-advanced-query",children:"Scan Filters: Advanced Query"}),"\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsxs)(o.li,{children:[(0,i.jsx)(o.strong,{children:"WorkflowQuery"}),": Use advanced visibility query syntax for complex filtering."]}),"\n",(0,i.jsxs)(o.li,{children:[(0,i.jsx)(o.strong,{children:"SamplingRate"}),": Sampling workflows from the scan result before executing the replay test."]}),"\n"]}),"\n",(0,i.jsx)(o.h4,{id:"scan-filters-basic",children:"Scan Filters: Basic"}),"\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsxs)(o.li,{children:[(0,i.jsx)(o.strong,{children:"WorkflowTypes"}),": A list of workflow Type names."]}),"\n",(0,i.jsxs)(o.li,{children:[(0,i.jsx)(o.strong,{children:"WorkflowStatus"}),": A list of workflow statuses. (",(0,i.jsx)(o.a,{href:"https://github.com/cadence-workflow/cadence-go-client/blob/2af19f25b056ce1039feaeabd3fb0e803d20010b/internal/workflow_shadower.go#L72",children:"accepted values"}),") ",(0,i.jsx)("br",{}),(0,i.jsx)(o.em,{children:"Note"}),': By default, an empty status list will only scan for "OPEN" workflows.']}),"\n",(0,i.jsxs)(o.li,{children:[(0,i.jsx)(o.strong,{children:"WorkflowStartTimeFilter"}),": Min and max timestamp for workflow start time."]}),"\n",(0,i.jsxs)(o.li,{children:[(0,i.jsx)(o.strong,{children:"SamplingRate"}),": Sampling workflows from the scan result before executing the replay test."]}),"\n"]}),"\n",(0,i.jsxs)(o.blockquote,{children:["\n",(0,i.jsxs)(o.p,{children:["\u26a0\ufe0f ",(0,i.jsx)(o.strong,{children:"Compatibility Rule:"})," Use either WorkflowQuery OR the basic filters (WorkflowTypes/WorkflowStatus/WorkflowStartTimeFilter). SamplingRate works with both approaches."]}),"\n"]}),"\n",(0,i.jsx)(o.h4,{id:"shadow-exit-condition",children:"Shadow Exit Condition"}),"\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsxs)(o.li,{children:[(0,i.jsx)(o.strong,{children:"ExpirationInterval"}),": Shadowing will exit when the specified interval has passed."]}),"\n",(0,i.jsxs)(o.li,{children:[(0,i.jsx)(o.strong,{children:"ShadowCount"}),": Shadowing will exit after this number of workflows have been replayed. Note: replay may be skipped due to errors like cannot fetch history, history too short, etc. Skipped workflows won't be taken into account in ShadowCount."]}),"\n"]}),"\n",(0,i.jsx)(o.h4,{id:"shadow-mode",children:"Shadow Mode"}),"\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsxs)(o.li,{children:[(0,i.jsx)(o.strong,{children:"Normal"}),": Shadowing will complete after all workflows that match WorkflowQuery (after sampling) have been replayed or when exit condition is met."]}),"\n",(0,i.jsxs)(o.li,{children:[(0,i.jsx)(o.strong,{children:"Continuous"}),": A new round of shadowing will be started after all workflows that match WorkflowQuery have been replayed. There will be a 5-minute wait period between each round, and currently this wait period is not configurable. Shadowing will complete only when ExitCondition is met. ExitCondition must be specified when using this mode."]}),"\n"]}),"\n",(0,i.jsx)(o.h4,{id:"shadow-concurrency",children:"Shadow Concurrency"}),"\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsxs)(o.li,{children:[(0,i.jsx)(o.strong,{children:"Concurrency"}),": The default workflow replay concurrency is 1. Values greater than 1 only apply to a Shadowing Worker."]}),"\n"]}),"\n",(0,i.jsx)(o.h3,{id:"sample-integration-test",children:"Sample Integration Test"}),"\n",(0,i.jsxs)(o.p,{children:["Local shadowing with the Workflow Shadower is similar to the replay test. First create a workflow shadower with optional shadow and replay options, then register the workflow that needs to be shadowed. Finally, call the ",(0,i.jsx)(o.code,{children:"Run"})," method to start the shadowing. The method will return if shadowing has finished or any non-deterministic error is found."]}),"\n",(0,i.jsxs)(o.p,{children:["Here's a simple example. The example is also available ",(0,i.jsx)(o.a,{href:"https://github.com/cadence-workflow/cadence-samples/blob/6350c61d16487d3a6cf9b31e3fac6967170c71ba/cmd/samples/recipes/helloworld/shadow_test.go#L21",children:"here"}),"."]}),"\n",(0,i.jsx)(o.pre,{children:(0,i.jsx)(o.code,{className:"language-go",children:'func TestShadowWorkflow(t *testing.T) {\n\toptions := worker.ShadowOptions{\n\t\tWorkflowStartTimeFilter: worker.TimeFilter{\n\t\t\tMinTimestamp: time.Now().Add(-time.Hour),\n\t\t},\n\t\tExitCondition: worker.ShadowExitCondition{\n\t\t\tShadowCount: 10,\n\t\t},\n\t}\n\n  // please check the Worker Service page for how to create a cadence service client\n\tservice := buildCadenceClient()\n\tshadower, err := worker.NewWorkflowShadower(service, "samples-domain", options, worker.ReplayOptions{}, zaptest.NewLogger(t))\n\tassert.NoError(t, err)\n\n\tshadower.RegisterWorkflowWithOptions(helloWorldWorkflow, workflow.RegisterOptions{Name: "helloWorld"})\n\tassert.NoError(t, shadower.Run())\n}\n'})}),"\n",(0,i.jsx)(o.h2,{id:"shadowing-worker",children:"Shadowing Worker"}),"\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsx)(o.li,{children:(0,i.jsx)(o.strong,{children:"Each user domain is limited to one Shadowing Worker."})}),"\n",(0,i.jsx)(o.li,{children:(0,i.jsx)(o.strong,{children:'Each Shadowing Worker runs a single shadowing workflow in the "cadence-shadower" domain. You must create this domain before running a Shadowing Worker.'})}),"\n",(0,i.jsx)(o.li,{children:(0,i.jsx)(o.strong,{children:"The Cadence server used for scanning and getting workflow history will also be the Cadence server for running your shadow workflow. Currently, there's no way to specify different Cadence servers for hosting the shadowing workflow and scanning/fetching workflow."})}),"\n"]}),"\n",(0,i.jsx)(o.p,{children:"Your worker can also be configured to run in shadow mode to run shadow tests as a workflow. This is useful if there are a number of workflows that need to be replayed. Using a workflow can make sure the shadowing won't accidentally fail in the middle and the replay load can be distributed by deploying more shadow mode workers. It can also be incorporated into your deployment process to make sure there's no failed replay checks before deploying your change to production workers."}),"\n",(0,i.jsx)(o.p,{children:"When running in shadow mode, the normal decision, activity and session worker will be disabled so that it won't update any production workflows. A special shadow activity worker will be started to execute activities for scanning and replaying workflows. The actual shadow workflow logic is controlled by Cadence server and your worker is only responsible for scanning and replaying workflows."}),"\n",(0,i.jsxs)(o.p,{children:[(0,i.jsx)(o.a,{href:"https://github.com/cadence-workflow/cadence-go-client/blob/654b9a72a6abb40317387c8d97b19d882d1aaa6c/internal/common/metrics/constants.go#L108-L111",children:"Replay succeed, skipped, and failed metrics"})," will be emitted by your worker when executing the shadow workflow and you can monitor those metrics to see if there's any incompatible changes."]}),"\n",(0,i.jsxs)(o.p,{children:["To enable the shadow mode, the only change needed is setting the ",(0,i.jsx)(o.code,{children:"EnableShadowWorker"})," field in ",(0,i.jsx)(o.code,{children:"worker.Options"})," to ",(0,i.jsx)(o.code,{children:"true"}),", and then specify the ",(0,i.jsx)(o.code,{children:"ShadowOptions"}),"."]}),"\n",(0,i.jsxs)(o.p,{children:["Registered workflows will be forwarded to the underlying WorkflowReplayer. DataConverter, WorkflowInterceptorChainFactories, ContextPropagators, and Tracer specified in the ",(0,i.jsx)(o.code,{children:"worker.Options"})," will also be used as ReplayOptions. Since all shadow workflows are running in one system domain, to avoid conflict, ",(0,i.jsxs)(o.strong,{children:["the actual task list name used will be ",(0,i.jsx)(o.code,{children:"domain-tasklist"}),"."]})]}),"\n",(0,i.jsx)(o.h3,{id:"how-to-set-up",children:"How to Set Up"}),"\n",(0,i.jsxs)(o.p,{children:["A sample of this setup can be found ",(0,i.jsx)(o.a,{href:"https://github.com/cadence-workflow/cadence-samples/blob/6350c61d16487d3a6cf9b31e3fac6967170c71ba/cmd/samples/recipes/helloworld/main.go#L77",children:"here"}),"."]})]})}function h(e={}){const{wrapper:o}={...(0,t.R)(),...e.components};return o?(0,i.jsx)(o,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}}}]);